/*! ngapi - v0.1.7 - 2013-12-08 | Copyright (c) 2013 Po-Ju Chen <tonyone0902@gmail.com> */

"use strict";angular.module("ngapi",[]).factory("apiroutes",["api","$http",function(a,b){if("string"==typeof a.url)return a.url;if("object"==typeof a.url){var c={};return angular.forEach(a.url,function(a,d){var e=/http:/;b.get(a).success(function(b){c[d]=b,e.test(a)&&(c[d].url="http://"+a.replace("http://","").split("/")[0])})}),c}}]).service("apitools",function(a){this.apiroutes={},this.status=[],this.validate={email:function(a){var b=/.+\@.+\..+/;return b.test(a)},number:function(a){var b=/[0-9]/g;return b.test(a)},string:function(a){var b=/\w+/;return a.match(b)[0]==a?!0:!1},nospace:function(a){var b=/\s/g;return!b.test(a)}},this.reg={init:function(a){return a.split(/^\(/)[1].split(/\)$/)[0].split("||")},specColon:function(a){var b=/:/;return b.test(a)?a.split(/:/):!1},detectcallback:function(a){var b=/\w+((\w+\,)+)/;return b.test(a)}},this.api={scope:{},validatedata:function(a,b,c){this.status.length=0;var d=this.reg.specColon,e=this.validate;angular.forEach(a,function(a){e[d(a)[1]]?e[d(a)[1]](b[d(a)[0]])||this.status.push(!1):c[d(a)[1]](b[d(a)[0]])||this.status.push(!1)})}.bind(this),typeofapi:function(){return typeof apiroutes},passcheck:function(a){return this.reg.specColon(a[0])[0]||this.apiroutes[a[0].split(".")[0]][a[0].replace(a[0].split(".")[0]+".","")].methods[0].toLowerCase()}.bind(this),http:function(b,c,d,e,f){var g=a;g[b](c,d).success(function(a,b,c,d){return e?e.apply(e,[a,b,c,d]):void 0}).error(function(a,b,c,d){return f?f.apply(f,[a,b,c,d]):void 0})}.bind(this),get:function(){return{url:function(a,b){if("string"==typeof b){var c=[];c.push(b),b=c}switch(a){case"string":return this.apiroutes+this.reg.specColon(b[0])[1];case"object":return this.apiroutes[b[0].split(".")[0]].url+this.apiroutes[b[0].split(".")[0]][b[0].replace(b[0].split(".")[0]+".","")].path}}.bind(this),data:function(){}.bind(this)}}.bind(this),getnonceapi:function(a){return this.reg.specColon(a[0])[1]}.bind(this),restfullogin:function(a,b,c,d,e,f,g){var h=this.scope,i=this.getnonceapi(b),j=(b[1],function(a){{var b=f(h.password);f([b,a.data.nonce,g].sort().join(""))}});this.http("post",this.apiroutes+i,"",j,h[e])},sentapi:function(a,b,c,d,e,f,g){var h=this.get(),i=this.scope,j=this.http;if(e=e.replace(/()/,""),d=d.replace(/()/,""),"restfullogin"==a)return this.restfullogin(a,b,c,d,e,f,g);switch(a){case"get":if("string"==this.typeofapi){var k=h.url("string",b),l={};return angular.forEach(c,function(a){l[a.split(":")[0]]=i[a.split(":")[0]]}),j("get",k,{params:l})}var k=h.url("object",b);return j("get",k,"",i[d],i[e]);case"post":if("string"==this.typeofapi)var k=h.url("string",b);else var k=h.url("object",b);var l={};return angular.forEach(c,function(a){l[a.split(":")[0]]=i[a.split(":")[0]]}),j("post",k,l,i[d],i[e])}},error:{typeError:function(){throw new SyntaxError("Your ng-api value is wrong! must be=>(data)(method:apiurl)")}}}}).directive("ngApi",["apiroutes","apitools","api","$http",function(a,b,c,d){return{replace:!0,restrict:"AE",link:function(e,f,g){d.defaults.useXDomain=!0;var h=c.cnonce||"",i=c.crypto||"",j=c.validate||{},k=g.ngApi.replace(" ",""),l=/(\(.*\))(\(.*\))/,m=/(^\(\(|^\(\w+\(.*)/,n=k.match(l)||"",o=b.api;b.apiroutes=a;var p=e;f.bind("click",function(){if(o.scope=p,""==n||l.test(n[1])||n[1].match(m)||n[2].match(m)){if(!k)return o.error.typeError();o.sentapi("get",k,"",g.apiSuccess,g.apiError)}else{var a=b.reg.init(n[1]),c=b.reg.init(n[2]);o.validatedata(a,p,j);var d=o.passcheck(c);if(0==status.length)return o.sentapi(d,c,a,g.apiSuccess,g.apiError,i,h)}})}}}]);